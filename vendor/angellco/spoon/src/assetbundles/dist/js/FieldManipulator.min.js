!function(g){"undefined"==typeof Spoon&&(Spoon={}),Spoon.FieldManipulator=Garnish.Base.extend({$matrixContainer:null,init:function(e){this.setSettings(e,Spoon.FieldManipulator.defaults),this.refreshMatrixContainers(),"entrytype"===this.settings.context.split(":")[0]&&Garnish.on(Craft.EntryTypeSwitcher,"typeChange",g.proxy(function(e){this.settings.context="entrytype:"+g("#entryType").val(),this.processMatrixFields()},this)),this.addListener(Garnish.$win,"resize",g.proxy(function(){this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(g.proxy(this,"processMatrixFields"),25)},this))},refreshMatrixContainers:function(){this.$matrixContainer=Garnish.$doc.find(".matrix-field")},processMatrixFields:function(){this.refreshMatrixContainers();var t=this;this.$matrixContainer.each(function(){var e=g(this);t.initBlockTypeGroups(e),e.find("> .blocks > .matrixblock").each(function(){t.initBlocks(g(this),e)})})},initBlockTypeGroups:function(e){if(!e.data("spooned")){var t=this._getMatrixFieldName(e),n=[];if(void 0!==this.settings.blockTypes[this.settings.context]&&(n=g.grep(this.settings.blockTypes[this.settings.context],function(e){return e.fieldHandle===t})),n.length<1&&void 0!==this.settings.blockTypes.global&&(n=g.grep(this.settings.blockTypes.global,function(e){return e.fieldHandle===t})),1<=n.length){e.data("spooned",!0),e.data("spoon-block-types",n);var i=e.find("> .buttons").first();i.addClass("hidden");for(var a=g('<div class="buttons-spooned" />').insertAfter(i),s=g('<div class="btngroup" />').appendTo(a),o=g('<div class="btn add icon menubtn hidden">'+Craft.t("app","Add a block")+"</div>").appendTo(a),d=g('<div class="menu spoon-secondary-menu" />').appendTo(a),r=0;r<n.length;r++){if(0===s.find('[data-spooned-group="'+n[r].groupName+'"]').length){g('<div class="btn  menubtn">'+Craft.t("site",n[r].groupName)+"</div>").appendTo(s);var l=g('<div class="menu" data-spooned-group="'+n[r].groupName+'" />').appendTo(s),p=g("<ul />").appendTo(l);0!==r&&g("<hr>").appendTo(d),g("<h6>"+Craft.t("site",n[r].groupName)+"</h6>").appendTo(d);var h=g("<ul/>").appendTo(d)}$li=g('<li><a data-type="'+n[r].matrixBlockType.handle+'">'+Craft.t("site",n[r].matrixBlockType.name)+"</a></li>"),$li.appendTo(p),$li.clone().appendTo(h)}s.find(".menubtn").each(function(){new Garnish.MenuBtn(g(this),{onOptionSelect:function(e){var t=g(e).data("type");i.find('[data-type="'+t+'"]').trigger("click")}})}),new Garnish.MenuBtn(o,{onOptionSelect:function(e){var t=g(e).data("type");i.find('[data-type="'+t+'"]').trigger("click")}}),this.addListener(e,"resize",g.proxy(function(){(e.data("spoon-main-buttons-width")||(e.data("spoon-main-buttons-width",s.width()),e.data("spoon-main-buttons-width")))&&(e.width()<e.data("spoon-main-buttons-width")?(o.removeClass("hidden"),s.addClass("hidden")):(o.addClass("hidden"),s.removeClass("hidden")))},this))}}},initBlocks:function(e,t){if(e.data("spooned"))Garnish.$doc.trigger("scroll");else{e.data("spooned",!0);var n=t.data("spoon-block-types");if(void 0!==n&&1<=n.length){var i=e.find(".actions .settings.menubtn");this.initSettingsMenu(i,n,t);var a=this._getMatrixBlockTypeHandle(e),s=g.grep(n,function(e){return e.matrixBlockType.handle===a});if(1===s.length&&null!==s[0].fieldLayoutId)e.data("spooned-block-type",s[0]),this.initBlockFieldLayout(e,t);else if(this.settings.blockTypes.hasOwnProperty("global")){var o=this._getMatrixFieldName(t);1<=(n=g.grep(this.settings.blockTypes.global,function(e){return e.fieldHandle===o})).length&&1===(s=g.grep(n,function(e){return e.matrixBlockType.handle===a})).length&&null!==s[0].fieldLayoutId?(e.data("spooned-block-type",s[0]),this.initBlockFieldLayout(e,t)):e.addClass("matrixblock-not-spooned")}else e.addClass("matrixblock-not-spooned")}else e.addClass("matrixblock-not-spooned")}},initBlockFieldLayout:function(e,t){var n=e.data("spooned-block-type"),r=n.fieldLayoutModel.tabs,l=n.fieldLayoutModel.fields;if(1<=r.length){e.addClass("matrixblock-spooned");var p=t.prop("id")+"-"+e.data("id"),h="spoon-"+p,c=g('<ul class="spoon-tabs"/>').appendTo(e),u=g('<div class="spoon-fields"/>').css({opacity:0}).appendTo(e),f=e.find("> .fields");f.css({opacity:0}),setTimeout(g.proxy(function(){for(var t=0;t<r.length;t++){var e="",n="";if(0==t?e=" sel":n=" hidden",1<r.length)var i=g("<li/>").appendTo(c),a=g('<a id="'+h+"-"+t+'" class="tab'+e+'">'+Craft.t("site",r[t].name)+"</a>").appendTo(i).data("spooned-tab-target","#"+h+"-pane-"+t);for(var s=g('<div id="'+h+"-pane-"+t+'" class="'+n+'"/>').appendTo(u),o=g.grep(l,function(e){return e.tabId===r[t].id}),d=0;d<o.length;d++)f.find("#"+p+"-fields-"+o[d].handle+"-field").appendTo(s);0<s.find(".field.has-errors").length&&(a.addClass("error"),a.append(' <span data-icon="alert" />'))}1<r.length&&this.addListener(c.find("a"),"click","onTabClick"),f.hide(),u.velocity({opacity:1},"fast",g.proxy(function(){Craft.initUiElements(u)},this))},this),110)}},onTabClick:function(e){e.preventDefault(),e.stopPropagation();var t=g(e.target),n=t.parent().parent(".spoon-tabs"),i=t.data("spooned-tab-target"),a=g(i);n.find("a.sel").removeClass("sel"),t.addClass("sel"),a.siblings("div").addClass("hidden"),a.removeClass("hidden")},initSettingsMenu:function(l,p,h){setTimeout(g.proxy(function(){var e=l.data("menubtn")||!1;if(e){var t=this._getMatrixFieldName(h),n=e.menu.$container;n.addClass("spoon-settings-menu"),n.find('a[data-action="add"]').parents("li").addClass("hidden"),n.find("hr").removeClass("padded");for(var i=n.find('a[data-action="add"]').parents("li").parent("ul"),a=0;a<p.length;a++){var s=p[a].matrixBlockType.handle;if(0===n.find('[data-spooned-group="'+p[a].groupName+'"]').length)if(g.grep(this.settings.nestedSettingsHandles,function(e){return e===t}).length){var o=g('<ul class="padded hidden" data-spooned-group="'+p[a].groupName+'" />');0!==a&&g("<hr/>").insertBefore(i);var d=g('<a class="fieldtoggle">'+Craft.t("site",p[a].groupName)+"</a>");d.insertBefore(i),o.insertBefore(i),this.addListener(d,"click",function(e){var t=g(e.currentTarget),n=t.next("ul");n.hasClass("hidden")?(n.removeClass("hidden"),t.addClass("expanded")):(n.addClass("hidden"),t.removeClass("expanded"))})}else{o=g('<ul class="padded" data-spooned-group="'+p[a].groupName+'" />');0!==a&&g("<hr/>").insertBefore(i),g("<h6>"+Craft.t("site",p[a].groupName)+"</h6>").insertBefore(i),o.insertBefore(i)}var r=n.find('a[data-type="'+s+'"]').parents("li");o.append(r),r.removeClass("hidden")}}else this.initSettingsMenu(l,p,h)},this),0)},_getMatrixFieldName:function(e){var t=e.parentsUntil(".field").parent().prop("id").split("-");if(9===t.length)var n=t[t.length-8]+"-"+t[t.length-5]+"-"+t[t.length-2];else if(6===t.length)n=t[t.length-5]+"-"+t[t.length-2];else if(3===t.length)n=t[t.length-2];return""!=n&&n},_getMatrixBlockTypeHandle:function(e){var t=e.find('> input[type="hidden"][name*="type"]').val();return"string"==typeof t&&t}},{defaults:{blockTypes:null,context:!1,nestedSettingsHandles:[]}}),Garnish.$win.on("load",function(){void 0===Spoon.fieldmanipulator?setTimeout(function(){Spoon.fieldmanipulator.processMatrixFields()},250):Spoon.fieldmanipulator.processMatrixFields()})}(jQuery);