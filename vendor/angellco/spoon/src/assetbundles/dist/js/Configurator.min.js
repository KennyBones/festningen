!function(d){"undefined"==typeof Spoon&&(Spoon={}),Spoon.Configurator=Garnish.Base.extend({$container:null,fields:[],$form:null,$body:null,$bigSpinner:null,$spinner:null,modal:null,init:function(t,i){this.$container=d(t),this.setSettings(i,Spoon.Configurator.defaults),"global"===this.settings.context?(this.addListener(this.$container.find(".edit"),"click","onFieldConfiguratorClick"),this.addListener(this.$container.find(".delete"),"click","onRemoveConfiguration")):(setTimeout(d.proxy(this.modifySettingsButtons,this),0),this.$container.on("mousedown",this.settings.fieldSelector,d.proxy(this.onFieldMouseDown,this)))},onRemoveConfiguration:function(t){var o=d(t.target),i={context:"global",fieldId:o.data("spoon-field-id")};Craft.postActionRequest("spoon/block-types/delete",i,d.proxy(function(t,i){"success"==i&&t.success?(Craft.cp.displayNotice(Craft.t("spoon","Block type groups deleted.")),o.addClass("hidden")):"success"==i&&Craft.cp.displayError(Craft.t("app","There was an unknown error."))},this))},onFieldMouseDown:function(t){t.preventDefault(),t.stopPropagation(),this.modifySettingsButtons()},modifySettingsButtons:function(){var n=this;this.fields=[],this.$container.find(n.settings.fieldSelector).each(function(){var t=d(this).data("id").toString();-1!==d.inArray(t,n.settings.matrixFieldIds)&&n.fields.push(d(this))}),d.each(this.fields,function(){var t=d(this);if(!t.data("spoon-configurator-initialized")){var i=t.find("a.settings").data("menubtn")||!1;if(!i)return;var o=i.menu.$container;o.find("ul").children(":first").clone(!0).prependTo(o.find("ul:first")).find("a:first").text(Craft.t("spoon","Group block types")).data("spoon-field-id",t.data("id")).attr("data-action","spoon").on("click",d.proxy(n.onFieldConfiguratorClick,n)),t.data("spoon-configurator-initialized",!0)}})},onFieldConfiguratorClick:function(t){t.preventDefault(),t.stopPropagation();var i=d(t.target);this.$form=d('<form class="modal elementselectormodal spoon-configurator"/>');var o=i.data("spoon-field-id");this.$form.data("spoon-field-id",o),this.$body=d('<div class="body"/>').appendTo(this.$form),this.$body=d('<div class="content"/>').appendTo(this.$body),this.$bigSpinner=d('<div class="spinner big"/>').appendTo(this.$body),this.$body=d('<div class="main"/>').appendTo(this.$body);var n=d('<div class="footer"/>').appendTo(this.$form),e=d('<div class="buttons right"/>').appendTo(n);this.$spinner=d('<div class="spinner hidden"/>').appendTo(e);var s=d('<div class="btn">'+Craft.t("app","Cancel")+"</div>").appendTo(e),a=d('<input type="submit" class="btn submit" value="'+Craft.t("app","Save")+'"/>').appendTo(e);this.modal=new Garnish.Modal(this.$form,{resizable:!0,closeOtherModals:!0,onFadeIn:d.proxy(function(){this._populateModal()},this),onHide:d.proxy(function(){this.modal.$container.remove(),this.modal.$shade.remove()},this)}),this.addListener(this.$form,"submit","_handleSubmit"),this.addListener(a,"click",d.proxy(function(t){t.preventDefault(),this.$form.one("blockTypesSaved",d.proxy(function(){this.modal.hide(),"global"===this.settings.context&&i.parent("td").parent("tr").find(".delete").removeClass("hidden")},this)),this.$form.trigger("submit")},this)),this.addListener(s,"click",d.proxy(function(){this.modal.hide()},this))},_handleSubmit:function(t){t.preventDefault(),this.$spinner.removeClass("hidden");var i=this.$form.serialize();i+="&context="+this.settings.context,Craft.postActionRequest("spoon/block-types/save",i,d.proxy(function(t,i){this.$spinner.addClass("hidden"),"success"==i&&t.success?(Craft.cp.displayNotice(Craft.t("spoon","Block type groups saved.")),this._populateModal(),this.$form.trigger("blockTypesSaved")):"success"==i&&Craft.cp.displayError(Craft.t("spoon","There was an unknown error saving some block type groups."))},this))},_populateModal:function(){var t={fieldId:this.$form.data("spoon-field-id"),context:this.settings.context};Craft.postActionRequest("spoon/configurator/get-html",t,d.proxy(function(t,i){if("success"==i){this.$body.html(t.html),this.$bigSpinner.addClass("hidden");new Spoon.GroupsDesigner("#spoon-configurator",{fieldInputName:"spoonedBlockTypes[__TAB_NAME__][]",context:this.settings.context})}},this))}},{defaults:{matrixFieldIds:null,context:!1,fieldSelector:".fld-tabcontent > .fld-field"}})}(jQuery);